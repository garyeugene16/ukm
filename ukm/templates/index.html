<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kampus UKM Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #e74c3c; --bg-terminal: #1e1e1e; }
        body { background-color: #ecf0f1; font-family: 'Segoe UI', sans-serif; }
        
        .main-card { border: none; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .terminal-window {
            background-color: var(--bg-terminal);
            color: #00ff00;
            font-family: 'Consolas', 'Courier New', monospace;
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid #333;
        }
        .log-line { margin-bottom: 4px; line-height: 1.4; border-bottom: 1px solid #2b2b2b; }
        .log-agent { color: #f1c40f; font-weight: bold; }
        .log-system { color: #3498db; }
        
        /* Step Progress */
        .step-container { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .step-item { text-align: center; opacity: 0.4; transition: 0.3s; }
        .step-item.active { opacity: 1; transform: scale(1.1); font-weight: bold; color: var(--accent-color); }
        
        /* Result Card */
        .result-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center; align-items: center;
        }
        .ticket-card {
            background: white; width: 350px; padding: 0; border-radius: 20px;
            overflow: hidden; animation: slideUp 0.5s ease;
        }
        /* Tambahkan ini di bawah style .ticket-card yang lama */
        .ticket-card {
            transition: all 0.3s ease; /* Biar animasi lebar halus */
        }

        /* Kelas khusus untuk mode 2 kolom */
        .ticket-card-wide {
            width: 800px !important; /* Paksa jadi lebar */
            max-width: 95%;
        }
        .ticket-header { background: var(--accent-color); color: white; padding: 20px; text-align: center; }
        .ticket-body { padding: 25px; }
        
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card main-card">
                <div class="card-header bg-white p-4 text-center">
                    <h2 class="fw-bold text-dark"><i class="fas fa-university me-2"></i>Sistem Rekomendasi UKM</h2>
                    <p class="text-muted small">Menggunakan Database UKM dan LLM Ollama</p>
                </div>
                
                <div class="card-body p-4">
                    <div class="step-container px-5">
                        <div id="step-1" class="step-item active"><i class="fas fa-user-edit fa-2x mb-2"></i><br>Masukan Cerita</div>
                        <div id="step-2" class="step-item"><i class="fas fa-search-dollar fa-2x mb-2"></i><br>Analisis LLM</div>
                        <div id="step-3" class="step-item"><i class="fas fa-balance-scale fa-2x mb-2"></i><br>Rekomendasi Akhir</div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-5">
                            <label class="form-label fw-bold">Ceritakan hobi, tujuan, dan kepribadian kamu:</label>
                            <textarea id="storyInput" class="form-control mb-3" rows="6" placeholder="Misal: Saya suka debat bahasa inggris dan ingin melatih public speaking..."></textarea>
                            <button onclick="startRecommendation()" id="btnStart" class="btn btn-dark w-100 py-2">
                                <i class="fas fa-play me-2"></i>Cari Rekomendasi
                            </button>
                        </div>

                        <div class="col-md-7">
                            <label class="form-label fw-bold">System Log (Real-time):</label>
                            <div id="terminal" class="terminal-window">
                                <div class="text-muted">System ready. Waiting for input...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="resultPopup" class="result-overlay">
    <div class="ticket-card">
        <div class="ticket-header">
            <h4><i class="fas fa-check-circle"></i> Rekomendasi Terbaik</h4>
        </div>
        
        <div class="ticket-body" id="recommendation-list" style="max-height: 70vh; overflow-y: auto;">
            </div>

        <div class="p-3 bg-white border-top">
            <button onclick="closePopup()" class="btn btn-outline-danger w-100 btn-sm">Tutup</button>
        </div>
    </div>
</div>

<div id="emptyPopup" class="result-overlay">
    <div class="ticket-card">
        <div class="ticket-header bg-danger text-white">
            <h4><i class="fas fa-exclamation-triangle me-2"></i>Tidak ada UKM yang cocok</h4>
        </div>
        
        <div class="ticket-body text-center p-4">
            <div class="mb-3">
                <i class="fas fa-search fa-4x text-muted opacity-50"></i>
            </div>
            <h5 class="fw-bold text-dark">Maaf, belum ada UKM yang cocok sesuai dengan input kamu.</h5>
            <p class="text-muted small">
                Sepertinya minat kamu sangat unik dan belum tersedia di database Sistem Rekomendasi UKM Mahasiswa.
            </p>
            <div class="alert alert-warning small py-2">
                <i class="fas fa-lightbulb me-1"></i> Coba perbanyak input dengan menambah minat lain seperti: <b>Musik, Olahraga, atau Teknologi.</b>
            </div>
        </div>

        <div class="p-3 bg-white border-top">
            <button onclick="closeEmptyPopup()" class="btn btn-dark w-100 btn-sm">Coba Lagi</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const terminal = document.getElementById('terminal');
    
    async function startRecommendation() {
        const story = document.getElementById('storyInput').value;
        if(!story) return alert("Isi dulu ceritanya!");

        // UI Updates
        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnStart').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        terminal.innerHTML = '<div class="log-system"> > Initializing System Agents...</div>';
        setStep(2);

        // Call Backend
        await fetch('/start_process', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({story: story})
        });

        // Listen Stream
        const eventSource = new EventSource('/stream_logs');
        
        eventSource.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if(data.type === 'ping') return;
            
            if(data.type === 'done') {
                eventSource.close();
                // document.getElementById('btnStart').disabled = false;
                // document.getElementById('btnStart').innerHTML = '<i class="fas fa-play me-2"></i>Cari Rekomendasi';
                // setStep(1); 
                resetUI();
                return;
            }

            if(data.type === 'log') {
                const div = document.createElement('div');
                div.className = 'log-line';
                
                let content = data.content;
                if(content.includes("Intention_Analyst")) div.classList.add('log-agent');
                else if(content.includes("DATABASE_RESULT")) div.classList.add('log-system');
                else if(content.includes("Ukm_Advisor")) {
                    div.classList.add('log-agent');
                    setStep(3);
                }

                if(content.includes("ProfileAnalyzer")) div.classList.add('log-agent');
                else if(content.includes("DATABASE_RESULT")) div.classList.add('log-system');
                else if(content.includes("RecommendationWriter")) {
                    div.classList.add('log-agent');
                    setStep(3);
                }
                
                div.innerText = content;
                terminal.appendChild(div);
                terminal.scrollTop = terminal.scrollHeight;

                if (content.includes("DATABASE_STATUS: KOSONG")) {
                    eventSource.close(); // Stop stream
                    resetUI(); // Kembalikan tombol jadi normal
                    document.getElementById('emptyPopup').style.display = 'flex'; // Munculkan popup merah
                    return;
                }

                extractFinalJson(content);
            }
        };
    }

    function extractFinalJson(text) {
        // KITA KEMBALIKAN KE STRICT MODE
        // Regex ini HANYA mencari blok yang diawali ```json_final
        const regex = /```json_final([\s\S]*?)```/;
        const match = text.match(regex);
        
        if(match && match[1]) {
            try {
                const jsonStr = match[1].trim();
                const data = JSON.parse(jsonStr);
                
                // Pastikan ada key 'recommendations'
                if (data.recommendations) {
                    const listContainer = document.getElementById('recommendation-list');
                    const cardElement = document.querySelector('.ticket-card');
                    
                    listContainer.innerHTML = ''; 
                    const recs = data.recommendations || [];
                    
                    // Logika Lebar Popup
                    if (recs.length > 1) {
                        cardElement.classList.add('ticket-card-wide');
                        listContainer.className = 'ticket-body row g-3'; 
                    } else {
                        cardElement.classList.remove('ticket-card-wide');
                        listContainer.className = 'ticket-body';
                    }

                    recs.forEach((item, index) => {
                        const colClass = recs.length > 1 ? 'col-md-6' : 'col-12';
                        const themeColor = index === 0 ? 'primary' : 'success'; 
                        const badgeColor = index === 0 ? 'bg-primary' : 'bg-success';
                        const collapseId = `collapseReason-${index}`;

                        const html = `
                            <div class="${colClass}">
                                <div class="card h-100 border-${themeColor} shadow-sm">
                                    <div class="card-header bg-transparent border-0 pt-3 pb-0 d-flex justify-content-between align-items-center">
                                        <span class="badge ${badgeColor}">Pilihan #${index + 1}</span>
                                        <small class="text-muted"><i class="far fa-clock"></i> ${item.schedule}</small>
                                    </div>
                                    <div class="card-body">
                                        <h4 class="card-title fw-bold text-dark mb-3">${item.name}</h4>
                                        
                                        <div class="alert alert-light border-start border-4 border-${themeColor} py-2 px-3 mb-3">
                                            <small class="fw-bold text-muted d-block mb-1">Kenapa cocok?</small>
                                            <div class="text-dark small fst-italic">"${item.short_reason}"</div>
                                        </div>

                                        <button class="btn btn-outline-${themeColor} btn-sm w-100 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                            <i class="fas fa-chevron-down me-1"></i> Baca Alasan Lengkap
                                        </button>
                                        
                                        <div class="collapse" id="${collapseId}">
                                            <div class="card card-body bg-light border-0 small text-secondary mt-2">
                                                ${item.long_reason}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        listContainer.innerHTML += html;
                    });
                    
                    // MUNCULKAN POPUP
                    document.getElementById('resultPopup').style.display = 'flex';
                }
            } catch(e) { 
                console.error("Gagal parsing JSON Final:", e);
            }
        }
    }

    // Fungsi Reset Tombol (Biar rapi)
    function resetUI() {
        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnStart').innerHTML = '<i class="fas fa-play me-2"></i>Mulai Analisis';
        setStep(1);
    }

    // Fungsi Tutup Popup Merah
    function closeEmptyPopup() {
        document.getElementById('emptyPopup').style.display = 'none';
    }

    function setStep(num) {
        document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
        document.getElementById('step-'+num).classList.add('active');
    }

    function closePopup() {
        document.getElementById('resultPopup').style.display = 'none';
    }
</script>

</body>
</html>